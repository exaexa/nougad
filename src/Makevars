
# use `Sys.setenv` to choose a different compute capability
NOUGAD_GPU_ARCHS ?= 60 61 70 75 80 86

CXX_STD = CXX17

NVCC = nvcc -std=c++17

PKG_LIBS = $(shell pkg-config cuda --libs) -lcudart
PKG_CPPFLAGS = -I./include -I./kernels $(shell pkg-config cuda --cflags)
PKG_CXXFLAGS = -Wall -O3 -DNDEBUG -fPIC

GENCODES_LIST = $(foreach arch,$(NOUGAD_GPU_ARCHS),$(subst XX,$(arch),-gencode=arch=compute_XX,code=sm_XX))
NVCCFLAGS = -ccbin $(CXX17) $(PKG_CPPFLAGS) -Xcompiler "-fPIC" $(GENCODES_LIST)

CUDA_SOURCES = kernels/nougad.cu
CUDA_OBJECTS = $(CUDA_SOURCES:.cu=.cuo)

CXX_SOURCES = nougad.cpp
CXX_OBJECTS = $(CXX_SOURCES:.cpp=.o)

OBJECTS = $(CXX_OBJECTS) $(CUDA_OBJECTS)

all: nougad.so

nougad.so: $(OBJECTS)

%.cuo: %.cu
	$(NVCC) $(NVCCFLAGS) --compile -cudart static $< -o $@
